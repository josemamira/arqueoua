<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Yacimientos arqueol칩gicos</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="lib/maplibre-gl.css" rel="stylesheet" />
   
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }




        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 21.8%;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay input {
            margin: 2px;
        }

        #filter-result {
            font-size: 8px;
            font-family: "Courier New";
        }

        .legend {
            background-color: white;
            border-radius: 3px;
            bottom: 30px;
            padding: 10px;
            position: absolute;

            left: 10px;
            z-index: 1;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .legend h4 {
            margin: 0 0 5px;
        }

        .legend div {
            display: flex;
            align-items: center;
        }

        .legend span {
            height: 10px;
            width: 10px;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
    <script src="lib/maplibre-gl.js"></script>
    <script src="lib/maplibre-gl-svg.js"></script>
</head>

<body>
    <div id="map"></div>
    <div id="legend" class="legend"></div>



    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <nav id="nav-filter">

                <fieldset>
                    <legend>游삗 Tipolog칤a</legend>
                    <div>
                        <input id="tipo" type="checkbox" />
                        <label for="tipo">Aplicar filtro por <code>tipolog칤a</code> </label>
                        <div>
                            <div>
                                <label for="valor-tipo">Tipolog칤a:</label>
                                <select id="valor-tipo">
                                    <option value="Abrigo">Abrigo</option>
                                    <option value="Alfar">Alfar</option>
                                    <option value="Campamento al aire libre">Campamento al aire libre</option>
                                    <option value="Abrigo">Abrigo</option>
                                    <option value="Castellum">Castellum</option>
                                    <option value="Castillo">Castillo</option>
                                    <option value="Cueva">Cueva</option>
                                    <option value="Habitat concentrado">H치bitat concentrado</option>
                                    <option value="Habitat disperso">H치bitat disperso</option>
                                    <option value="Necropolis">Necr칩polis</option>
                                    <option value="Pecio">Pecio</option>
                                    <option value="Poblado" selected>Poblado</option>
                                    <option value="Poblado en altura">Poblado en altura</option>
                                    <option value="Santuario">Santuario</option>
                                    <option value="Torre">Torre</option>
                                    <option value="Villae">Villae</option>
                                </select>

                            </div>
                        </div>
                </fieldset>

                <legend>游늳 Periodo</legend>
                <div>
                    <input id="periodo" type="checkbox" />
                    <label for="periodo">Aplicar filtro por <code>periodo</code> </label>
                    <div>
                        <div>
                            <label for="valor-periodo">Periodo:</label>
                            <select id="valor-periodo">                                
                                <option value="Paleol칤tico">Paleol칤tico</option>
                                <option value="Mesolitico">Mesol칤tico</option>
                                <option value="Neol칤tico">Neol칤tico</option>
                                <option value="Calcolitico">Calcol칤tico</option>
                                <option value="Bronce">Bronce</option>
                                <option value="Hierro">Hierro</option>
                                <option value="Iberico">Ib칠rico</option>
                                <option value="Fenicio">Fenicio</option>
                                <option value="Arcaico">Arcaico</option>
                                <option value="Punico">P칰nico</option>
                                <option value="Romano - Republicano">Romano - Republicano</option>
                                <option value="Romano - Imperial" selected>Romano - Imperial</option>
                                <option value="Tardoantiguo">Tardoantiguo</option>
                                <option value="Medieval">Medieval</option>
                            </select>

                        </div>
                    </div>
                    </fieldset>
            </nav>
            <!-- <hr />
        <div id='filter-result'>["all"]</div>-->
        </div>
    </div>


    <script>
        const data = {};

        var map = new maplibregl.Map({
            container: 'map',
            //style: 'https://api.maptiler.com/maps/basic-v2/style.json?key=pXqZoLXkpIfigfdKwQ6Q',
            //style: 'https://demotiles.maplibre.org/style.json', // style URL                
            style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',            
            center: [4, 40],
            zoom: 5
        });



        // Agrega los puntos del archivo GeoJSON
        map.on('load', () => {
            fetch('data/yacimientos.geojson')
                .then(response => response.json())
                .then(data => {
                    map.addSource('yacimientos', {
                        'type': 'geojson',
                        'data': data
                    });
                            
                    // A침adir iconos personalizados
                    const icons = {                       
						'Arcaico': 'img/png/01_ArteRupestre_BN.png',
						'Paleolitico': 'img/png/02_Prehistoria_BN.png',
						'Mesolitico': 'img/png/02_Prehistoria_BN.png',
						'Neolitico': 'img/png/02_Prehistoria_BN.png',
						'Calcolitico': 'img/png/02_Prehistoria_BN.png',
						'Bronce': 'img/png/02_Prehistoria_BN.png',
						'Hierro': 'img/png/03_Protohistoria.png',
						'Mesolitico': 'img/png/02_Prehistoria_BN.png',
						'Iberico': 'img/png/03_Protohistoria.png',
						'Fenicio': 'img/png/04_Griego.png',
						'Punico': 'img/png/04_Griego.png',
						'Romano - Republicano': 'img/png/05_Romano.png',
						'Romano - Imperial': 'img/png/05_Romano.png',
						'Tardoantiguo': 'img/png/06_EdadMedia.png',
						'Medieval': 'img/png/06_EdadMedia.png',
						//'img/png/08_Contemporaneo.png'                       
                        
                        
                        
                    };
        
                    // A침adir im치genes al mapa
                    Object.keys(icons).forEach(key => {
						map.loadImage(icons[key], (error, image) => {
							if (error) throw error;
							map.addImage(key, image);
						});
					});
                    map.addLayer({
						id: 'yacimientos',
						type: 'symbol',
						source: 'yacimientos',
						layout: {
							'icon-image': ['get', 'periodo_1'],
							'icon-size': 1
						}
					});

                    map.addLayer({
                        'id': 'yacimientos_circulos',
                        'type': 'circle',
                        'source': 'yacimientos',
                        'maxzoom':8,
                        /*'layout': {
                            'icon-image': ['get', 'tipo'], // Usar el atributo 'tipo' para seleccionar el icono
                            'icon-size': 0.1 // Ajusta el tama침o del icono seg칰n sea necesario
                        }*/
                        'paint': {
                            'circle-radius': 8,
                            /*'circle-color': '#B42222'*/
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#000000',
                            'circle-color': [
                                'match',
                                ['get', 'periodo_1'],
                                'Arcaico', '#a6cee3',
                                'Paleolitico', '#1f78b4',
                                'Bronce', '#b2df8a',
                                'Hierro', '#33a02c',
                                'Iberico', '#fb9a99',
                                'Fenicio', '#e31a1c',
                                'Punico', '#fdbf6f',
                                'Romano - Republicano', '#ff7f00',
                                'Romano - Imperial', '#cab2d6',
				/* other */ '#d9d9d9'
                            ]
                        }
                    });                   

                    // A침adir una capa de etiquetas
                    map.addLayer({
                        'id': 'yacimientos-labels',
                        'type': 'symbol',
                        'source': 'yacimientos',
                        'minzoom':8,
                        'layout': {
                            'text-field': ['get', 'yacimiento'],
                            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 1.25],
                            'text-anchor': 'top'
                            //,'text-color': 'red'
                        },
                        'paint': {
							'text-color': 'white',
							'text-halo-color': 'seagreen',
							'text-halo-width': 2
						  }
                    });

                    // Crear la leyenda
                    const legend = document.getElementById('legend');
                    const types = [ 'Paleol칤tico','Bronce', 'Hierro', 'Ib칠rico', 'Fenicio', 'Arcaico','P칰nico', 'Romano - Republicano', 'Romano - Imperial', 'Otros'];
                    const colors = ['#1f78b4',    '#b2df8a','#33a02c','#fb9a99', '#e31a1c', '#a6cee3','#fdbf6f', '#ff7f00', '#cab2d6', '#d9d9d9'];

                    legend.innerHTML = '<h4>Periodos</h4>';
                    types.forEach((type, index) => {
                        const color = colors[index];
                        const item = document.createElement('div');
                        item.innerHTML = `<span style="background-color: ${color};"></span>${type}`;
                        legend.appendChild(item);
                    });



                    // Opcional: Agrega un popup al hacer clic en un punto
                    map.on('click', 'yacimientos', (e) => {
                        var enlace = '';
                        if (e.features[0].properties.enlace == null) { enlace = ''; } else { enlace = '<a href="' + e.features[0].properties.enlace + '" target="_blank">enlace</a>'; }
                        if (e.features[0].properties.tipologi_1 == null) { tipo2 = ''; } else { tipo2 = e.features[0].properties.tipologi_1; }
                        if (e.features[0].properties.periodo_2 == null) { periodo2 = ''; } else { periodo2 = e.features[0].properties.periodo_2; }
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML('<h3>' + e.features[0].properties.yacimiento + '</h3><p><ul>' +
                                '<li>Municipio: <b>' + e.features[0].properties.municipio + '</b></li>' +
                                '<li>Pa칤s: <b>' + e.features[0].properties.pais + '</b></li>' +
                                '<li>Tipolog칤a :<b>' + e.features[0].properties.tipologia + '</b></li>' +
                                '<li>Tipolog칤a 2: <b>' + tipo2 + '</b></li>' +
                                '<li>Periodo: <b>' + e.features[0].properties.periodo_1 + '</b></li>' +
                                '<li>Periodo 2: <b>' + periodo2 + '</b></li>' +
                                '<li>Enlace: ' + enlace + '</li>' +
                                //'<li>Enlace: <a href="'+e.features[0].properties.enlace+'">'+e.features[0].properties.enlace+'</a></li>'+                            
                                '</ul></p>')
                            .addTo(map);
                    });

                    // Cambia el cursor a una mano cuando el rat칩n pasa por encima de los puntos
                    map.on('mouseenter', 'yacimientos', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    // Cambia el cursor de nuevo cuando el rat칩n deja de estar sobre los puntos
                    map.on('mouseleave', 'yacimientos', () => {
                        map.getCanvas().style.cursor = '';
                    });
                });
        });

        document.getElementById('nav-filter').addEventListener('change', (e) => {
            let filterOnValue = ['all'];
            let operator = '==';

            switch (e.target.id) {               
                case 'tipo':
                    valorTipo = document.getElementById('valor-tipo');
                    operator = '==';
                    e.target.checked ? data.tipologia = valorTipo.value : delete data['tipologia'];
                    break;

                case 'periodo':
                    valorPeriodo = document.getElementById('valor-periodo');
                    operator = '==';
                    e.target.checked ? data.periodo_1 = valorPeriodo.value : delete data['periodo_1'];
                    break;

                default:
                    console.log('default');
            }

            filterOnValue = Object.keys(data);

            mapLibreFilterSpread = ['all', ...filterOnValue.map(id => [operator, id, data[id]])];
            mapLibreFilter = mapLibreFilterSpread;

            //document.getElementById('filter-result').textContent = JSON.stringify(mapLibreFilter);
            
            map.setFilter('yacimientos', mapLibreFilter);
            console.log(mapLibreFilter);
        });





    </script>
</body>

</html>
